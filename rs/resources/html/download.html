<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Preparando descarga...</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; }
    .progress-bar-bg {
      width: 80%; margin: 30px auto; background: #eee; border-radius: 20px; height: 25px;
    }
    .progress-bar {
      height: 100%; width: 0%; background: #4caf50; border-radius: 20px; transition: width 0.2s;
    }
  </style>
</head>
<body>
  <h1>Estamos preparando tu archivo para descarga</h1>
  <h2 id="filename">archivo.xlsx</h2>

  <div class="progress-bar-bg">
    <div class="progress-bar" id="bar"></div>
  </div>

 
  <script>
    let data = {};
    try {
      data = JSON.parse(window.name || '{}');
    } catch (e) {
      document.body.innerHTML = '<h2>Error: No se pudo obtener la información del archivo a descargar.</h2>';
      throw e;
    }

    const fileUrl = data.url;
    const params = data.params || {};
	let title = "archivo.xlsx";

	try {
	  const url = new URL("http://dummyhost" + fileUrl); // Añadir host para que funcione como URL válida
	  const dgExport = url.searchParams.get("dg_export");

	  if (dgExport) {
	    const parts = dgExport.split(",");
	    for (const part of parts) {
	      if (part.startsWith("title___op1=")) {
	        title = decodeURIComponent(part.split("=")[1]);
	        break;
	      }
	    }
	  }
	} catch (e) {
	  console.warn("No se pudo extraer el título de la URL:", e);
	}
    document.getElementById("filename").textContent = title;
   // document.getElementById(" haz clic aquí.lLink").href = fileUrl;

    let progress = 0;
    const bar = document.getElementById("bar");

    const interval = setInterval(() => {
      progress += 5;
      if (progress > 100) progress = 100;
      bar.style.width = progress + '%';

      if (progress >= 100) {
        clearInterval(interval);

        // Crear un formulario y enviarlo por POST al backend
        const form = document.createElement("form");
        form.method = "post";
        form.action = fileUrl;
        form.style.display = "none";

        for (const key in params) {
          if (params.hasOwnProperty(key)) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = key;
            input.value = params[key];
            form.appendChild(input);
          }
        }

        document.body.appendChild(form);
        form.submit();
      }
    }, 100);
  </script>
</body>
</html>
